##call libraries##
library(dplyr)
library(ggplot2)
library(stringr)    # string operations
library(sf)         # spatial operations
library(readr)      # CSV I/O
library(scales)     # squish() for color capping
library(stringdist) # fuzzy matching
library(tidyverse)
library(survey)


##installing required libraries (option 1)##
install.packages("devtools")
devtools::install_github("ropensci/rdhs")
library(rdhs)

install.packages("survey")

# Install remotes if you don't have it (option 2)

if (!require("remotes")) install.packages("remotes")

# Install rdhs from GitHub

remotes::install_github("ropensci/rdhs")
library(rdhs)

## load data file
data <- read.csv("DHS/DHS_ITN_person_data.csv")


##creating dataset by parts
##for adequate ITN

data6<- data %>% 
  select(country, admin1_dhs, admin1_name, dhsid, urban_rural,
         clusterid, householdid,personid,netid,slept_under_net_types) %>%
  mutate(across(netid, ~ replace_na(netid, 0))) %>%
  mutate(has_ITN=ifelse(netid>0&
                          (slept_under_net_types=="treated and untreated nets"|slept_under_net_types=="treated nets"),1,0))%>%
  group_by(householdid) %>%
  mutate(across(has_ITN, ~ replace_na(has_ITN, 0))) %>%
  mutate(HHmember_count=n_distinct(personid))%>%
  filter(netid==max(netid))%>%
  select(-c(personid))%>%
  slice(1)


##creating variables to be used in calculating indicators

HH_data <- data6 %>%
  mutate(
    net_per_person = netid / HHmember_count)

### Create survey design with clusters only (no weights/strata)
svy_design <- svydesign(
  ids = ~clusterid,      # Primary sampling unit (PSU)
  strata = NULL,         # No stratification
  weights = ~1,          # Equal weights (assume self-weighting)
  data = HH_data,
  nest = TRUE            # Handle nested households if applicable
)

##create ITN utilization
data_with_ITN_use<- data %>% 
  select(country, admin1_dhs, admin1_name, dhsid, urban_rural,
         clusterid, householdid,personid,slept_under_net_types,sex,
         slept_under_itn) %>%
  mutate(itn_use =
           ifelse(slept_under_itn == "yes",1,     # Yes
                  ifelse(slept_under_itn == "no", 0, NA)))

##creating ITN utilization variables
HH_ITN_utilization_variables<-data_with_ITN_use %>%
  group_by(householdid) %>%
  mutate(ITN_use_count=n_distinct(itn_use))%>%
  mutate(HHmember_count=n_distinct(personid))%>%
  select(-c(personid,sex,slept_under_net_types,slept_under_itn,itn_use))%>%
  slice(1)


##computing ITN utilization

HH_with_ITN_utilization<-HH_ITN_utilization_variables %>%
  mutate(ITN_utilization=ITN_use_count/HHmember_count)

##save in excell

write.csv(HH_with_ITN_utilization, "C:/Users/HP EliteBook/OneDrive/Desktop/Group 2/data/HH_with_ITN_utilization.csv", row.names = FALSE)

write.csv(HH_ITN_utilization_variables, "C:/Users/HP EliteBook/OneDrive/Desktop/Group 2/data/HH_ITN_utilization_variables.csv", row.names = FALSE)

write.csv(data_with_ITN_use, "C:/Users/HP EliteBook/OneDrive/Desktop/Group 2/data/data_with_ITN_use.csv", row.names = FALSE)

write.csv(HH_data, "C:/Users/HP EliteBook/OneDrive/Desktop/Group 2/data/HH_data.csv", row.names = FALSE)

write.csv(data6, "C:/Users/HP EliteBook/OneDrive/Desktop/Group 2/data/data6.csv", row.names = FALSE)

##other day

##adding age group##

##create age group variable
ITN_age_data<- data %>% 
  select(country, admin1_dhs, admin1_name, dhsid, urban_rural,
         clusterid, householdid,personid,slept_under_net_types,sex,
         slept_under_itn,age) %>%
  mutate(itn_use =
           ifelse(slept_under_itn == "yes",1,     # Yes
                  ifelse(slept_under_itn == "no", 0, NA)))%>%
  mutate(age_group =
           ifelse(age<=5,1,ifelse(5<age<=16,2,ifelse(age>16,3,NA))))%>%
  select(-c(age))


##creating ITN utilization variables

data_with_ITN_use_1<- data %>% 
  select(country, admin1_dhs, admin1_name, SurveyId, urban_rural,
         clusterid, householdid,personid,slept_under_net_types,sex,
         slept_under_itn) %>%
  mutate(itn_use =
           ifelse(slept_under_itn == "yes",1,     # Yes
                  ifelse(slept_under_itn == "no", 0, NA)))


##location
country_ITN_utilization<-data_with_ITN_use_1 %>%
  group_by(country,SurveyId, urban_rural) %>%
  mutate(ITN_use_count=n_distinct(itn_use))%>%
  mutate(HHmember_count=n_distinct(personid))%>%
  mutate(ITN_utilization=ITN_use_count/HHmember_count) %>% 
  select(-c(personid,admin1_dhs, admin1_name,slept_under_net_types,slept_under_itn,itn_use))%>%
  slice(1)

## tutorial
ggplot(data=country_ITN_utilization,aes(x=SurveyId,y=ITN_utilization,group=urban_rural))+
  geom_line(aes(color=urban_rural))+theme_bw()+labs(x="Survey year",y="ITN Utilization ratio",title="Trend of ITN Utilization")+
  theme(plot.title = element_text(hjust = 0.5,face="bold"),axis.text.x = element_text(angle = 90,hjust =0.2))+
  facet_wrap(~country, scales ="free")

##sex

country_ITN_utilization<-data_with_ITN_use_1 %>%
  group_by(country,SurveyId, urban_rural,sex) %>%
  mutate(ITN_use_count=n_distinct(itn_use))%>%
  mutate(HHmember_count=n_distinct(personid))%>%
  mutate(ITN_utilization=ITN_use_count/HHmember_count) %>% 
  select(-c(personid,admin1_dhs, admin1_name,slept_under_net_types,slept_under_itn,itn_use))%>%
  slice(1)

## tutorial
ggplot(data=country_ITN_utilization,aes(x=SurveyId,y=ITN_utilization,group=sex))+
  geom_line(aes(color=sex))+theme_bw()+labs(x="Survey year",y="ITN Utilization ratio",title="Trend of ITN Utilization")+
  theme(plot.title = element_text(hjust = 0.5,face="bold"),axis.text.x = element_text(angle = 90,hjust =0.2))+
  facet_wrap(~country, scales ="free")


geom_point
ggplot(data=country_ITN_utilization,aes(x=,,y=ITN_utilization,group=urban_rural))+
  geom_point(aes(color=urban_rural))+theme_bw()+labs(x="Survey year",y="ITN Utilization ratio",title="Trend of ITN Utilization")+
  theme(plot.title = element_text(hjust = 0.5,face="bold"),axis.text.x = element_text(angle = 90,hjust =0.2))+
  facet_wrap(~country, scales ="free")

##region
country_ITN_utilization<-data_with_ITN_use_1 %>%
  group_by(country,SurveyId, admin1_name) %>%
  mutate(ITN_use_count=n_distinct(itn_use))%>%
  mutate(HHmember_count=n_distinct(personid))%>%
  mutate(ITN_utilization=ITN_use_count/HHmember_count) %>% 
  select(-c(personid,admin1_dhs,urban_rural,slept_under_net_types,slept_under_itn,itn_use))%>%
  slice(1)

## tutorial
ggplot(data=country_ITN_utilization,aes(x=admin1_name,y=ITN_utilization,group=sex))+
  geom_line(aes(color=sex))+theme_bw()+labs(x="survey regions",y="ITN Utilization ratio",title="Trend of ITN Utilization")+
  theme(plot.title = element_text(hjust = 0.5,face="bold"),axis.text.x = element_text(angle = 90,hjust =0.2))+
  facet_wrap(~country, scales ="free")
